<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Çø„Ç∏„Ç™„Ç´„É¨„É≥„ÉÄ„Éº - „Çπ„Çø„Ç∏„Ç™‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.15/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.15/index.global.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 13px;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        .nav a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .nav a.active {
            background-color: rgba(255,255,255,0.3);
        }
        .tabs {
            display: flex;
            background: white;
            padding: 10px;
            gap: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tabs a {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 10px 15px;
            background: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tabs a:hover {
            background: #e0e0e0;
        }
        .tabs a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            padding: 10px;
            overflow-x: auto;
        }
        #calendar {
            background: white;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .fc-event {
            cursor: pointer;
            font-size: 11px;
        }
        .fc .fc-toolbar {
            font-size: 14px;
        }
        .fc .fc-toolbar-title {
            font-size: 16px;
        }
        .fc .fc-button {
            padding: 4px 8px;
            font-size: 12px;
        }
        .fc .fc-col-header-cell {
            font-size: 11px;
            padding: 5px 2px;
        }
        .fc .fc-timegrid-slot-label {
            font-size: 10px;
            padding: 0 2px;
        }
        .fc .fc-datagrid-cell-cushion {
            font-size: 12px;
            padding: 4px;
        }
        .fc-daygrid-event {
            font-size: 11px;
            padding: 1px 2px;
        }
        
        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: #667eea;
            font-size: 20px;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        .form-group .required {
            color: red;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group input[readonly] {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: #999;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 768px) {
            .fc .fc-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            .fc .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé∏ „Çπ„Çø„Ç∏„Ç™„Ç´„É¨„É≥„ÉÄ„Éº</h1>
        <div class="nav">
            <a th:href="@{/dashboard}">„Éõ„Éº„É†</a>
            <a th:href="@{/manage}">‰∫àÁ¥ÑÁÆ°ÁêÜ</a>
            <a th:href="@{/calendar/studio}" class="active">„Ç´„É¨„É≥„ÉÄ„Éº</a>
            <a th:href="@{/profile}">„Éó„É≠„Éï„Ç£„Éº„É´</a>
            <a th:href="@{/bbs}">Êé≤Á§∫Êùø</a>
            <a th:href="@{/events}">„Ç§„Éô„É≥„Éà</a>
            <a th:href="@{/logout}">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        </div>
    </div>

    <div class="tabs">
        <a th:href="@{/calendar/studio}" class="active">üé∏ „Çπ„Çø„Ç∏„Ç™</a>
        <a th:href="@{/calendar/hamajirushi}">üç¥ „ÅØ„Åæ„Åò„Çã„Åó</a>
        <a th:href="@{/calendar/roxette}">üé§ Roxette</a>
    </div>

    <div class="container">
        <div id="calendar"></div>
    </div>

    <!-- ‰∫àÁ¥Ñ‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‰∫àÁ¥Ñ‰ΩúÊàê</h2>
                <span class="close" onclick="closeReservationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>‰∫àÁ¥ÑËÄÖÂêç</label>
                    <input type="text" id="reserverName" readonly />
                </div>
                <div class="form-group">
                    <label>ÈÉ®Â±ã</label>
                    <input type="text" id="roomName" readonly />
                </div>
                <div class="form-group">
                    <label>ÈñãÂßãÊôÇÂàª <span class="required">*</span></label>
                    <input type="datetime-local" id="startTime" required />
                </div>
                <div class="form-group">
                    <label>ÁµÇ‰∫ÜÊôÇÂàª <span class="required">*</span></label>
                    <input type="datetime-local" id="endTime" required />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmReservation()">‰∫àÁ¥Ñ„Åô„Çã</button>
                <button class="btn btn-secondary" onclick="closeReservationModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    let pendingReservation = null;
    let calendar = null;
    const currentUserName = /*[[${currentUserName}]]*/ null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        // „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂà§ÂÆöÔºöPCÔºà768px‰ª•‰∏äÔºâ„ÅØÈÄ±„Éì„É•„Éº„ÄÅ„É¢„Éê„Ç§„É´„ÅØÊó•„Éì„É•„Éº
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        const initialView = isMobile ? 'resourceTimeGridDay' : 'resourceTimeGridWeek';

        calendar = new FullCalendar.Calendar(calendarEl, {
            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
            locale: 'ja',
            height: 'auto',
            initialView: initialView,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'resourceTimeGridDay,resourceTimeGridWeek,dayGridMonth'
            },
            
            views: {
                resourceTimeGridDay: {
                    buttonText: 'Êó•',
                    slotMinTime: '00:00:00',
                    slotMaxTime: '24:00:00',
                    slotDuration: '00:30:00',
                    slotLabelInterval: '01:00:00'
                },
                resourceTimeGridWeek: {
                    type: 'resourceTimeGrid',
                    buttonText: 'ÈÄ±',
                    duration: { weeks: 1 },
                    slotMinTime: '00:00:00',
                    slotMaxTime: '24:00:00',
                    slotDuration: '00:30:00',
                    slotLabelInterval: '01:00:00'
                },
                dayGridMonth: {
                    buttonText: 'Êúà'
                }
            },
            
            datesAboveResources: true,
            nowIndicator: true,
            editable: true,
            selectable: true,
            selectMirror: true,
            dayMaxEvents: true,
            
            resources: [
                { id: 'A', title: '„Çπ„Çø„Ç∏„Ç™ A' },
                { id: 'B', title: '„Çπ„Çø„Ç∏„Ç™ B' }
            ],
            
            events: function(fetchInfo, successCallback, failureCallback) {
                fetch('/api/events')
                    .then(r => r.json())
                    .then(data => {
                        const filtered = data.filter(e => e.resourceId === 'A' || e.resourceId === 'B');
                        successCallback(filtered);
                    })
                    .catch(err => {
                        console.error('Error fetching events:', err);
                        failureCallback(err);
                    });
            },
            
            select: function(info) {
                pendingReservation = {
                    resourceId: info.resource ? info.resource.id : 'A',
                    start: info.startStr,
                    end: info.endStr
                };
                
                // „É¢„Éº„ÉÄ„É´„Å´ÊÉÖÂ†±„ÇíË®≠ÂÆö
                document.getElementById('reserverName').value = currentUserName || '';
                document.getElementById('roomName').value = '„Çπ„Çø„Ç∏„Ç™ ' + pendingReservation.resourceId;
                document.getElementById('startTime').value = formatDateTimeForInput(info.start);
                document.getElementById('endTime').value = formatDateTimeForInput(info.end);
                
                // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                document.getElementById('reservationModal').style.display = 'block';
                
                calendar.unselect();
            },
            
            eventClick: function(info) {
                const eventName = info.event.title;
                const eventId = info.event.id;
                
                // Ëá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (eventName === currentUserName) {
                    // Ëá™ÂàÜ„ÅÆ‰∫àÁ¥ÑÔºöÁ∑®ÈõÜÁîªÈù¢„Å´ÈÅ∑Áßª
                    if (confirm('„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÁ∑®ÈõÜ„Åó„Åæ„Åô„ÅãÔºü\n\n‰∫àÁ¥ÑËÄÖ: ' + eventName + '\nÈñãÂßã: ' + info.event.start.toLocaleString('ja-JP') + '\nÁµÇ‰∫Ü: ' + (info.event.end ? info.event.end.toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö'))) {
                        window.location.href = '/reservations/' + eventId + '/edit';
                    }
                } else {
                    // ‰ªñ‰∫∫„ÅÆ‰∫àÁ¥ÑÔºöË©≥Á¥∞Ë°®Á§∫„ÅÆ„Åø
                    alert('‰∫àÁ¥ÑË©≥Á¥∞\n\n‰∫àÁ¥ÑËÄÖ: ' + eventName + '\nÈñãÂßã: ' + info.event.start.toLocaleString('ja-JP') + '\nÁµÇ‰∫Ü: ' + (info.event.end ? info.event.end.toLocaleString('ja-JP') : 'Êú™Ë®≠ÂÆö') + '\n\n‚ÄªËá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„ÅÆ„ÅøÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô');
                }
            },
            
            eventDrop: function(info) {
                const eventName = info.event.title;
                
                // Ëá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„ÅÆ„ÅøÁßªÂãïÂèØËÉΩ
                if (eventName !== currentUserName) {
                    info.revert();
                    alert('Ëá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„ÅÆ„ÅøÁßªÂãï„Åß„Åç„Åæ„Åô');
                    return;
                }
                
                const newResource = info.event.getResources()[0];
                const resourceId = newResource ? newResource.id : undefined;
                
                fetch('/api/events/' + info.event.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: info.event.startStr,
                        end: info.event.endStr,
                        resourceId: resourceId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'ok') {
                        info.revert();
                        alert(data.error?.message || 'ÁßªÂãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                })
                .catch(error => {
                    info.revert();
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    console.error(error);
                });
            },
            
            eventResize: function(info) {
                const eventName = info.event.title;
                
                // Ëá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„ÅÆ„Åø„É™„Çµ„Ç§„Ç∫ÂèØËÉΩ
                if (eventName !== currentUserName) {
                    info.revert();
                    alert('Ëá™ÂàÜ„ÅÆ‰∫àÁ¥Ñ„ÅÆ„ÅøÂ§âÊõ¥„Åß„Åç„Åæ„Åô');
                    return;
                }
                
                fetch('/api/events/' + info.event.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: info.event.startStr,
                        end: info.event.endStr
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'ok') {
                        info.revert();
                        alert(data.error?.message || 'Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                })
                .catch(error => {
                    info.revert();
                    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    console.error(error);
                });
            }
        });

        calendar.render();
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆ„Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        window.addEventListener('resize', function() {
            const nowMobile = window.matchMedia('(max-width: 768px)').matches;
            const currentView = calendar.view.type;
            
            if (nowMobile && currentView === 'resourceTimeGridWeek') {
                calendar.changeView('resourceTimeGridDay');
            } else if (!nowMobile && currentView === 'resourceTimeGridDay') {
                calendar.changeView('resourceTimeGridWeek');
            }
        });
    });
    
    // Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞Ôºàdatetime-localÁî®Ôºâ
    function formatDateTimeForInput(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    function closeReservationModal() {
        document.getElementById('reservationModal').style.display = 'none';
        pendingReservation = null;
    }
    
    // ‰∫àÁ¥Ñ„ÇíÁ¢∫ÂÆö
    function confirmReservation() {
        const name = currentUserName;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        if (!name) {
            alert('„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
            return;
        }
        
        if (!startTime || !endTime) {
            alert('ÈñãÂßãÊôÇÂàª„Å®ÁµÇ‰∫ÜÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        
        // datetime-localÂΩ¢Âºè„ÇíISO 8601ÂΩ¢Âºè„Å´Â§âÊèõ
        const start = startTime + ':00';
        const end = endTime + ':00';
        
        fetch('/api/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                resourceId: pendingReservation.resourceId,
                name: name,
                start: start,
                end: end
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                calendar.refetchEvents();
                closeReservationModal();
            } else {
                alert(data.error?.message || '‰∫àÁ¥Ñ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        })
        .catch(error => {
            alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            console.error(error);
        });
    }
    
    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    window.onclick = function(event) {
        const modal = document.getElementById('reservationModal');
        if (event.target === modal) {
            closeReservationModal();
        }
    }
    /*]]>*/
    </script>
</body>
</html>