<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roxetteã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - ã‚¹ã‚¿ã‚¸ã‚ªäºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.15/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.15/index.global.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 13px;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        .nav a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .nav a.active {
            background-color: rgba(255,255,255,0.3);
        }
        .tabs {
            display: flex;
            background: white;
            padding: 10px;
            gap: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tabs a {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 10px 15px;
            background: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tabs a:hover {
            background: #e0e0e0;
        }
        .tabs a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .notice {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin: 15px;
            border-radius: 5px;
            color: #004085;
            font-size: 14px;
        }
        .container {
            padding: 15px;
        }
        #calendar {
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 20px;
        }
        .modal-header h2 {
            color: #667eea;
            font-size: 22px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group .required {
            color: red;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: #999;
            color: white;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .event-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .event-info p {
            margin-bottom: 8px;
            color: #666;
        }
        .event-info strong {
            color: #333;
        }
        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* FullCalendarç©ºãæ ã‚¹ã‚¿ã‚¤ãƒ« */
        .fc-event.slot-event {
            background-color: #e0e0e0 !important;
            border-color: #999 !important;
            color: #666 !important;
        }
        
        .fc-event.booked-event {
            background-color: #a29bfe !important;
            border-color: #8b7edc !important;
        }
        
        @media (max-width: 768px) {
            .time-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤ Roxetteãƒ©ã‚¤ãƒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
        <div class="nav">
            <a th:href="@{/dashboard}">ãƒ›ãƒ¼ãƒ </a>
            <a th:href="@{/manage}">äºˆç´„ç®¡ç†</a>
            <a th:href="@{/calendar/roxette}" class="active">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
            <a th:href="@{/profile}">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
            <a th:href="@{/bbs}">æ²ç¤ºæ¿</a>
            <a th:href="@{/events}">ã‚¤ãƒ™ãƒ³ãƒˆ</a>
            <a th:href="@{/logout}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>
    </div>

    <div class="tabs">
        <a th:href="@{/calendar/studio}">ğŸ¸ ã‚¹ã‚¿ã‚¸ã‚ª</a>
        <a th:href="@{/calendar/hamajirushi}">ğŸ´ ã¯ã¾ã˜ã‚‹ã—</a>
        <a th:href="@{/calendar/roxette}" class="active">ğŸ¤ Roxette</a>
    </div>

    <div class="notice" sec:authorize="hasRole('ADMIN')">
        ğŸ”‘ ç®¡ç†è€…: ç©ºãæ—¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ ã‚’ä½œæˆã§ãã¾ã™ã€‚ç©ºãæ ã¾ãŸã¯ç™»éŒ²æ¸ˆã¿ãƒ©ã‚¤ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
    </div>
    
    <div class="notice" sec:authorize="hasRole('USER') and !hasRole('ADMIN')">
        â„¹ï¸ è–„ã„ã‚°ãƒ¬ãƒ¼ã®ç©ºãæ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ©ã‚¤ãƒ–ç™»éŒ²ã§ãã¾ã™ã€‚ç™»éŒ²æ¸ˆã¿ã®ãƒ©ã‚¤ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
    </div>

    <div class="container">
        <div id="calendar"></div>
    </div>

    <!-- ç®¡ç†è€…ç”¨ï¼šæ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="slotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="slotModalTitle">ãƒ©ã‚¤ãƒ–æ ä½œæˆ</h2>
            </div>
            <div class="event-info">
                <p><strong>æ—¥ä»˜:</strong> <span id="slotDate"></span></p>
            </div>
            <form id="slotForm">
                <input type="hidden" id="slotEventId">
                <input type="hidden" id="slotDateValue">
                
                <div class="time-grid">
                    <div class="form-group">
                        <label>é–‹å§‹æ™‚é–“ <span class="required">*</span></label>
                        <select id="slotStartTime" required>
                            <!-- 30åˆ†å˜ä½ã§ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>çµ‚äº†æ™‚é–“ <span class="required">*</span></label>
                        <select id="slotEndTime" required>
                            <!-- 30åˆ†å˜ä½ã§ç”Ÿæˆ -->
                        </select>
                    </div>
                </div>
                
                <div class="time-grid">
                    <div class="form-group">
                        <label>æ¼”å¥æ™‚é–“ï¼ˆåˆ†ï¼‰ <span class="required">*</span></label>
                        <input type="number" id="performanceTime" value="15" min="5" max="60" step="5" required>
                    </div>
                    
                    <div class="form-group">
                        <label>è»¢æ›æ™‚é–“ï¼ˆåˆ†ï¼‰ <span class="required">*</span></label>
                        <input type="number" id="changeoverTime" value="10" min="0" max="30" step="5" required>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">æ ã‚’ä½œæˆ</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSlotModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
                <div class="button-group" id="slotDeleteButtonGroup" style="display: none;">
                    <button type="button" class="btn btn-danger" onclick="deleteSlot()">æ ã‚’å‰Šé™¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼šãƒ©ã‚¤ãƒ–ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="liveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="liveModalTitle">ãƒ©ã‚¤ãƒ–ç™»éŒ²</h2>
            </div>
            <div class="event-info" id="liveInfo">
                <p><strong>æ :</strong> <span id="slotDateTime"></span></p>
                <p id="slotDetailsInfo" style="font-size: 13px; color: #666; margin-top: 5px;"></p>
            </div>
            <form id="liveForm">
                <input type="hidden" id="liveEventId">
                <input type="hidden" id="liveSlotId">
                <input type="hidden" id="liveStart">
                <input type="hidden" id="liveEnd">
                
                <div class="form-group" id="timeSlotGroup" style="display: none;">
                    <label>å‡ºæ¼”æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆ <span class="required">*</span></label>
                    <select id="timeSlotSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        â€»æ¼”å¥æ™‚é–“ã¨è»¢æ›æ™‚é–“ã‚’å«ã‚€æ ã§ã™
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ä»£è¡¨è€…å <span class="required">*</span></label>
                    <input type="text" id="liveRepresentative" required placeholder="ä¾‹: å±±ç”°å¤ªéƒ" readonly style="background-color: #f0f0f0;">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        â€»ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ãƒãƒ³ãƒ‰å <span class="required">*</span></label>
                    <input type="text" id="liveBandName" required placeholder="ä¾‹: The Rockers">
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLiveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
                <div class="button-group" id="liveDeleteButtonGroup" style="display: none;">
                    <button type="button" class="btn btn-danger" onclick="deleteLive()">å‰Šé™¤</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    let calendar;
    let isAdmin = /*[[${#authorization.expression('hasRole(''ADMIN'')')}]]*/ false;
    let currentUserName = /*[[${currentUserName}]]*/ null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        // æ™‚é–“é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆ30åˆ†å˜ä½ï¼‰
        generateTimeOptions();

        calendar = new FullCalendar.Calendar(calendarEl, {
            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
            locale: 'ja',
            height: 'auto',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            nowIndicator: true,
            editable: false,
            selectable: false,
            
            events: function(fetchInfo, successCallback, failureCallback) {
                fetch('/api/events')
                    .then(r => r.json())
                    .then(data => {
                        const filtered = data.filter(e => e.resourceId === 'Roxette');
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                        filtered.forEach(e => {
                            if (e.isSlot) {
                                e.className = 'slot-event';
                            } else {
                                e.className = 'booked-event';
                            }
                        });
                        
                        successCallback(filtered);
                    })
                    .catch(err => failureCallback(err));
            },
            
            dateClick: function(info) {
                if (isAdmin) {
                    // ç®¡ç†è€…ï¼šæ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    openSlotModal(null, info.dateStr);
                }
            },
            
            eventClick: function(info) {
                const event = info.event;
                const isSlot = event.extendedProps.isSlot;
                
                if (isAdmin) {
                    // ç®¡ç†è€…ï¼šæ ã¾ãŸã¯ç™»éŒ²æ¸ˆã¿ãƒ©ã‚¤ãƒ–ã‚’ç·¨é›†
                    if (isSlot) {
                        openSlotModal(event);
                    } else {
                        openLiveModal(event);
                    }
                } else {
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    if (isSlot) {
                        // ç©ºãæ ï¼šãƒ©ã‚¤ãƒ–ç™»éŒ²
                        openLiveModal(event, true);
                    } else {
                        // ç™»éŒ²æ¸ˆã¿ãƒ©ã‚¤ãƒ–ï¼šç·¨é›†
                        openLiveModal(event, false);
                    }
                }
            }
        });

        calendar.render();
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('slotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSlot();
        });
        
        document.getElementById('liveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveLive();
        });
    });
    
    function generateTimeOptions() {
        const startSelect = document.getElementById('slotStartTime');
        const endSelect = document.getElementById('slotEndTime');
        
        for (let h = 10; h <= 23; h++) {
            for (let m of [0, 30]) {
                if (h === 23 && m === 30) break;
                const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                
                const optionStart = document.createElement('option');
                optionStart.value = time;
                optionStart.textContent = time;
                startSelect.appendChild(optionStart);
                
                const optionEnd = document.createElement('option');
                optionEnd.value = time;
                optionEnd.textContent = time;
                endSelect.appendChild(optionEnd);
            }
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
        startSelect.value = '19:00';
        endSelect.value = '22:00';
    }
    
    // ç®¡ç†è€…ç”¨ï¼šæ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
    function openSlotModal(event, dateStr = null) {
        const modal = document.getElementById('slotModal');
        modal.style.display = 'block';
        
        if (event) {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
            document.getElementById('slotModalTitle').textContent = 'æ ç·¨é›†';
            document.getElementById('slotEventId').value = event.id;
            document.getElementById('slotDate').textContent = 
                new Date(event.start).toLocaleDateString('ja-JP');
            
            const start = new Date(event.start);
            const end = new Date(event.end);
            
            document.getElementById('slotStartTime').value = 
                `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
            document.getElementById('slotEndTime').value = 
                `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('performanceTime').value = event.extendedProps.performanceTime || 15;
            document.getElementById('changeoverTime').value = event.extendedProps.changeoverTime || 10;
            document.getElementById('slotDateValue').value = event.startStr.split('T')[0];
            
            document.getElementById('slotDeleteButtonGroup').style.display = 'flex';
        } else {
            // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
            document.getElementById('slotModalTitle').textContent = 'ãƒ©ã‚¤ãƒ–æ ä½œæˆ';
            document.getElementById('slotEventId').value = '';
            document.getElementById('slotDate').textContent = 
                new Date(dateStr).toLocaleDateString('ja-JP');
            document.getElementById('slotDateValue').value = dateStr;
            
            document.getElementById('slotStartTime').value = '19:00';
            document.getElementById('slotEndTime').value = '22:00';
            document.getElementById('performanceTime').value = 15;
            document.getElementById('changeoverTime').value = 10;
            
            document.getElementById('slotDeleteButtonGroup').style.display = 'none';
        }
    }
    
    function closeSlotModal() {
        document.getElementById('slotModal').style.display = 'none';
    }
    
    function saveSlot() {
        const eventId = document.getElementById('slotEventId').value;
        const dateStr = document.getElementById('slotDateValue').value;
        const startTime = document.getElementById('slotStartTime').value;
        const endTime = document.getElementById('slotEndTime').value;
        const performanceTime = parseInt(document.getElementById('performanceTime').value);
        const changeoverTime = parseInt(document.getElementById('changeoverTime').value);
        
        const startDateTime = dateStr + 'T' + startTime + ':00';
        const endDateTime = dateStr + 'T' + endTime + ':00';
        
        const data = {
            resourceId: 'Roxette',
            name: 'ç©ºãæ ',
            start: startDateTime,
            end: endDateTime,
            isSlot: true,
            performanceTime: performanceTime,
            changeoverTime: changeoverTime
        };
        
        const url = eventId ? '/api/events/' + eventId : '/api/events';
        const method = eventId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                calendar.refetchEvents();
                closeSlotModal();
            } else {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            console.error(error);
        });
    }
    
    function deleteSlot() {
        const eventId = document.getElementById('slotEventId').value;
        
        if (!confirm('ã“ã®æ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆé–¢é€£ã™ã‚‹ãƒ©ã‚¤ãƒ–ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
            return;
        }
        
        fetch('/api/events/' + eventId, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                calendar.refetchEvents();
                closeSlotModal();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            console.error(error);
        });
    }
    
    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼šãƒ©ã‚¤ãƒ–ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openLiveModal(event, isNewRegistration = false) {
        const modal = document.getElementById('liveModal');
        modal.style.display = 'block';
        
        if (isNewRegistration) {
            // ç©ºãæ ã«æ–°è¦ç™»éŒ²
            document.getElementById('liveModalTitle').textContent = 'ãƒ©ã‚¤ãƒ–ç™»éŒ²';
            document.getElementById('liveEventId').value = '';
            document.getElementById('liveSlotId').value = event.id;
            
            // æ ã®æƒ…å ±ã‚’è¡¨ç¤º
            const slotStart = new Date(event.start);
            const slotEnd = new Date(event.end);
            document.getElementById('slotDateTime').textContent = 
                slotStart.toLocaleDateString('ja-JP') + ' ' +
                slotStart.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) + ' - ' +
                slotEnd.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
            
            const performanceTime = event.extendedProps.performanceTime || 15;
            const changeoverTime = event.extendedProps.changeoverTime || 10;
            const totalSlotTime = performanceTime + changeoverTime;
            
            document.getElementById('slotDetailsInfo').textContent = 
                `æ¼”å¥æ™‚é–“: ${performanceTime}åˆ† / è»¢æ›æ™‚é–“: ${changeoverTime}åˆ† (1æ : ${totalSlotTime}åˆ†)`;
            
            // åˆ©ç”¨å¯èƒ½ãªæ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
            generateTimeSlots(event.id, slotStart, slotEnd, performanceTime, changeoverTime);
            
            document.getElementById('timeSlotGroup').style.display = 'block';
            
            // ä»£è¡¨è€…åã‚’ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§è‡ªå‹•è¨­å®š
            document.getElementById('liveRepresentative').value = currentUserName || '';
            document.getElementById('liveRepresentative').readOnly = true;
            
            document.getElementById('liveBandName').value = '';
            
            // æ™‚é–“ã¯é¸æŠå¾Œã«è¨­å®šã™ã‚‹ãŸã‚ã€ç©ºã«ã—ã¦ãŠã
            document.getElementById('liveStart').value = '';
            document.getElementById('liveEnd').value = '';
            
            document.getElementById('liveDeleteButtonGroup').style.display = 'none';
        } else {
            // æ—¢å­˜ãƒ©ã‚¤ãƒ–ç·¨é›†
            document.getElementById('liveModalTitle').textContent = 'ãƒ©ã‚¤ãƒ–ç·¨é›†';
            document.getElementById('liveEventId').value = event.id;
            document.getElementById('liveSlotId').value = event.extendedProps.slotId || '';
            document.getElementById('liveStart').value = event.startStr;
            document.getElementById('liveEnd').value = event.endStr;
            
            const eventStart = new Date(event.start);
            const eventEnd = new Date(event.end);
            document.getElementById('slotDateTime').textContent = 
                eventStart.toLocaleDateString('ja-JP') + ' ' +
                eventStart.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) + ' - ' +
                eventEnd.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
            
            document.getElementById('slotDetailsInfo').textContent = 'ç™»éŒ²æ¸ˆã¿ãƒ©ã‚¤ãƒ–ã®ç·¨é›†';
            document.getElementById('timeSlotGroup').style.display = 'none';
            
            // ç·¨é›†æ™‚ã¯ä»£è¡¨è€…åã‚‚è¡¨ç¤ºï¼ˆreadonlyï¼‰
            document.getElementById('liveRepresentative').value = event.extendedProps.representative || '';
            document.getElementById('liveRepresentative').readOnly = true;
            
            document.getElementById('liveBandName').value = event.extendedProps.bandName || '';
            
            document.getElementById('liveDeleteButtonGroup').style.display = 'flex';
        }
    }
    
    // åˆ©ç”¨å¯èƒ½ãªæ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
    function generateTimeSlots(slotId, slotStart, slotEnd, performanceTime, changeoverTime) {
        const select = document.getElementById('timeSlotSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        const totalSlotTime = performanceTime + changeoverTime;
        const slotDurationMs = totalSlotTime * 60 * 1000;
        
        // æ—¢å­˜ã®äºˆç´„ã‚’å–å¾—ã—ã¦ã€åŸ‹ã¾ã£ã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’ç‰¹å®š
        fetch('/api/events')
            .then(r => r.json())
            .then(allEvents => {
                const bookedSlots = allEvents.filter(e => 
                    e.resourceId === 'Roxette' && 
                    !e.isSlot && 
                    e.slotId == slotId
                );
                
                let currentTime = new Date(slotStart);
                const endTime = new Date(slotEnd);
                
                while (currentTime < endTime) {
                    const slotEndTime = new Date(currentTime.getTime() + slotDurationMs);
                    
                    if (slotEndTime <= endTime) {
                        // ã“ã®ã‚¹ãƒ­ãƒƒãƒˆãŒæ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const isBooked = bookedSlots.some(booking => {
                            const bookingStart = new Date(booking.start);
                            const bookingEnd = new Date(booking.end);
                            return (
                                (currentTime >= bookingStart && currentTime < bookingEnd) ||
                                (slotEndTime > bookingStart && slotEndTime <= bookingEnd) ||
                                (currentTime <= bookingStart && slotEndTime >= bookingEnd)
                            );
                        });
                        
                        const option = document.createElement('option');
                        const startStr = currentTime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                        const endStr = slotEndTime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                        
                        option.value = JSON.stringify({
                            start: currentTime.toISOString(),
                            end: slotEndTime.toISOString()
                        });
                        
                        if (isBooked) {
                            option.textContent = `${startStr} - ${endStr} (äºˆç´„æ¸ˆã¿)`;
                            option.disabled = true;
                            option.style.color = '#999';
                        } else {
                            option.textContent = `${startStr} - ${endStr}`;
                        }
                        
                        select.appendChild(option);
                    }
                    
                    currentTime = new Date(currentTime.getTime() + slotDurationMs);
                }
            })
            .catch(error => {
                console.error('æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    }
    
    function closeLiveModal() {
        document.getElementById('liveModal').style.display = 'none';
    }
    
    function saveLive() {
        const eventId = document.getElementById('liveEventId').value;
        const slotId = document.getElementById('liveSlotId').value;
        const representative = document.getElementById('liveRepresentative').value;
        const bandName = document.getElementById('liveBandName').value;
        
        if (!representative) {
            alert('ä»£è¡¨è€…åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        if (!bandName) {
            alert('ãƒãƒ³ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        let startTime, endTime;
        
        // æ–°è¦ç™»éŒ²ã®å ´åˆã¯æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å–å¾—
        if (!eventId) {
            const timeSlotSelect = document.getElementById('timeSlotSelect');
            if (!timeSlotSelect.value) {
                alert('å‡ºæ¼”æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedSlot = JSON.parse(timeSlotSelect.value);
            startTime = selectedSlot.start;
            endTime = selectedSlot.end;
        } else {
            // æ—¢å­˜ç·¨é›†ã®å ´åˆã¯æ—¢å­˜ã®æ™‚é–“ã‚’ä½¿ç”¨
            startTime = document.getElementById('liveStart').value;
            endTime = document.getElementById('liveEnd').value;
        }
        
        const data = {
            resourceId: 'Roxette',
            name: bandName + ' (ä»£è¡¨: ' + representative + ')',
            start: startTime,
            end: endTime,
            representative: representative,
            bandName: bandName,
            slotId: slotId ? parseInt(slotId) : null,
            isSlot: false
        };
        
        const url = eventId ? '/api/events/' + eventId : '/api/events';
        const method = eventId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                calendar.refetchEvents();
                closeLiveModal();
            } else {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            console.error(error);
        });
    }
    
    function deleteLive() {
        const eventId = document.getElementById('liveEventId').value;
        
        if (!confirm('ã“ã®ãƒ©ã‚¤ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }
        
        fetch('/api/events/' + eventId, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'ok') {
                calendar.refetchEvents();
                closeLiveModal();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            console.error(error);
        });
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            closeSlotModal();
            closeLiveModal();
        }
    }
    /*]]>*/
    </script>
</body>
</html>